# Benching

This repository contains the benching files used to execute both the Simple Agda and Agda experiments as well as the Haskell files used for generating the experiments and processing the experiment results. 

This README will first cover the experiment data used for the master thesis. After that it will go over the codebase in case people want to make changes to the reports or generate their own experiments.

## Simple Agda Experiments

The Simple Agda experiments can be found in [experiments](experiments/). The experiments are grouped first by what major feature they focus on. Then the different experiments each have their own folder and in those we finally get the different steps within the experiments.

Within such a leaf experiment folder we find several different files. There are of course the actual experiments in the form of .sa files. They are accompanied by a README.md file which contains the settings used to generate the files. Finally, there is also a prefixes.md file. This contains the prefix of each of the different groups of files generated. This is needed for stat aggregation when using imports as we cannot average runtimes for two different kinds of files. See for example [imports/importChain/Chain3/prefixes.md](experiments/imports/importChain/Chain3/prefixes.md).

Besides these files there are also a variety of summary markdown files present. These are generated to summarise the raw data dumps generated by the experiments. The following types of files are generated, all containing markdown tables:

- filesizes.md: Contains the file size of the core files for for each version and for each file
- fileSizeAverages.md and fileSizeSummary.md: These can be found in the root folder. They contain the averages as well as filesizes relative to version 0 for each set of generated files in each folder. This means most folders have 1 average while the import experiments have multiple.
- averages.md: Contains the timing data averaged over the files generated. So it contains one table per prefix.
- percentages.md: Contains relative runtimes compared to version 0 for each individual file
- stats.md: Contains statistical data on a per file basis, it lists the average, standard-deviation, minimum and maximum times recorded
- summary.md: Contains relative times to version 0 averaged over all files.
- times.md: Timing data for each file, only averaged over repeated runs.

## Raw data

The raw experiment data can be found in [raw/](raw/). Raw files are generated for each run, of each version, on each folder. The filenames consist of the version followed by a timestamp.

The actual files consist of the following data:

- Whether core files/interface files were used
- The run number. (Needed for easier processing)
- The version
- The folder
- Blocks separated by a whiteline for each file in the folder containing:

    - the filename
    - semi-colon separated data containing the timinglabel, time spent in nanoseconds and how often the label triggered.

When dealing with imports the files are separated into a cacheOn and cacheOff folder for easier processing.

## Agda experiments

The Agda experiment can be found in [agdaFiles/](agdaFiles/). These experiments are also the reason for the [slow](agdaFiles/slow/) folder. This folder contains the last version of the [modAlias/NestedAliases](agdaFiles/modAlias/NestedAliases/) experiments. This file takes +- 20 minutes to typecheck and is split of to prevent it from accidentally being executed together with the other experiments for 10+ repititions as that will take a large amount of time for little benefit.

The experiments here are direct conversions created by [AgdaPrettyPrint](src/AgdaPrettyPrint.hs) from the Simple Agda experiments. To make the files equivalent, they use type annotations for all lambdas even though Agda's inference is strong enough to not need it most of the time. Furthermore, we use the $ operator to prevent Agda from optimising away lambdas.

## Experiment generation

The Simple Agda experiments were generated using the generator found in [Generator.hs](src/Generator.hs). The various configuration options can be found in the comments in this file. [GenMain.hs](src/GenMain.hs) then contains the function calls used to generate specific experiments.

The Agda experiments are conversions generated by [AgdaPrettyPrint](src/AgdaPrettyPrint.hs). Note that the conversion does not aim to create the best Agda code but instead Agda code that is as close as possible to Simple Agda.

## Experiment execution

[Main.hs](app/Main.hs) contains a variety of methods used to execute experiments. They are mostly methods used to bulk execute methods by calling the actual runners in [Runner.hs](src/Runner.hs) for Simple Agda or [AgdaRunner.hs](src/AgdaRunner.hs) for Agda.

The Agda experiments are multi-threaded to increase their speed. The Simple Agda experiments are not as our benchmarking library, timestats, cannot handle this.

The Agda experiments make use of an installed Agda executable(<=2.6.2.2) as using Agda as a library will not allow for as much optimization as we want.

## Result processing

The raw data files can be converted to the nicer summary markdown files by a variety of methods in [Processing.hs](src/Processing.hs) and [Rendering.hs](src/Rendering.hs).

[Plots.py](src/Plots.py) can then parse such a markdown table to generate plots.

